#!/usr/bin/env python3
import argparse
import json
import os
import subprocess
import sys

from dataclasses import dataclass
from typing import Optional


VERSION = "0.0.1"


STDLIB = """
panic() {
    echo "FATAL: ${*}" >&2
    exit 1
}

depends_on() {
    local this_dir
    this_dir="$(dirname "${BLARG_TARGET}")"
    for script_basename in "${@}"; do
        "${this_dir}/${script_basename}.bl"
    done
}

"""


BASE = """
reached_if() {
    false
}

apply() {
    true
}

"""


EXECUTOR = """

if ! reached_if &> /dev/null; then
    apply
fi
"""


@dataclass
class CliArgs:
    script_path: Optional[str]
    dump_src: bool
    version: bool


def parse_args() -> CliArgs:
    parser = argparse.ArgumentParser("blarg", description="Execute bash target files")
    parser.add_argument(
        "script_path", help="Script file to execute", default=None, nargs="?"
    )
    parser.add_argument(
        "--dump-src",
        "-d",
        help="Don't run the script; just dump the full source that would be executed by Bash",
        action="store_true",
    )
    parser.add_argument(
        "--version", "-v", help="Display version number", action="store_true"
    )
    args = parser.parse_args()
    return CliArgs(
        os.path.abspath(args.script_path) if args.script_path else None,
        args.dump_src,
        args.version,
    )


def main() -> int:
    args = parse_args()

    if args.version:
        print(f"blarg version {VERSION}")
        return 0

    with open(args.script_path, "r", encoding="utf8") as f:
        script = "".join(f.readlines())

    full_script = "".join([STDLIB, BASE, script, EXECUTOR])

    if args.dump_src:
        print(full_script)
        return 0

    env = os.environ
    env["BLARG_TARGET"] = args.script_path

    running_targets_unparsed = env.get("BLARG_RUNNING_TARGETS")
    if running_targets_unparsed:
        running_targets = json.loads(running_targets_unparsed)
    else:
        running_targets = []

    if args.script_path in running_targets:
        stack_seperator = "\n-> "
        print(
            f"FATAL: Circular dependency detected at `{args.script_path}`:\n"
            f"{stack_seperator.join(running_targets)}"
            f"{stack_seperator}{args.script_path}",
            file=sys.stderr,
        )
        return 1

    running_targets.append(args.script_path)
    env["BLARG_RUNNING_TARGETS"] = json.dumps(running_targets)

    result = subprocess.run(
        ["bash", "-Eeuo", "pipefail"],
        input=full_script,
        encoding="utf8",
        env=env,
    )

    return result.returncode


if __name__ == "__main__":
    exit_code = main()
    quit(exit_code)
